name: Manual Issue to PR

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to convert to PR'
        required: true
        type: string
      
jobs:
  create-pr-from-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Get issue details
        id: issue
        run: |
          # Get issue details using GitHub REST API directly
          issue_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}")
          
          issue_title=$(echo "$issue_response" | jq -r '.title')
          issue_body=$(echo "$issue_response" | jq -r '.body // ""')
          
          echo "issue_title=${issue_title}" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "${issue_body}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create branch name
        id: branch
        run: |
          title="${{ steps.issue.outputs.issue_title }}"
          branch_name="issue-${{ github.event.inputs.issue_number }}-$(echo "${title,,}" | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')"
          echo "branch_name=${branch_name}" >> $GITHUB_OUTPUT
          
      - name: Create and switch to new branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b ${{ steps.branch.outputs.branch_name }}
          
      - name: Create initial commit
        run: |
          echo "" >> README.md
          echo "## Working on Issue #${{ github.event.inputs.issue_number }}" >> README.md
          echo "**${{ steps.issue.outputs.issue_title }}**" >> README.md
          echo "" >> README.md
          echo "This branch was manually created to address the issue." >> README.md
          
          git add README.md
          git commit -m "Start working on #${{ github.event.inputs.issue_number }}: ${{ steps.issue.outputs.issue_title }}" -m "Closes #${{ github.event.inputs.issue_number }}"
          
      - name: Push branch
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin ${{ steps.branch.outputs.branch_name }}
          
      - name: Create Pull Request
        run: |
          # Create PR using GitHub REST API
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"Fix #${{ github.event.inputs.issue_number }}: ${{ steps.issue.outputs.issue_title }}\",
              \"body\": \"## Resolves Issue\\n\\nCloses #${{ github.event.inputs.issue_number }}\\n\\n## Description\\n\\n${{ steps.issue.outputs.issue_body }}\\n\\n## Implementation Plan\\n\\n- [ ] Analyze current code\\n- [ ] Implement fixes\\n- [ ] Test changes\\n- [ ] Update documentation if needed\\n\\n---\\n\\nðŸ¤– This PR was manually created from issue #${{ github.event.inputs.issue_number }}\",
              \"head\": \"${{ steps.branch.outputs.branch_name }}\",
              \"base\": \"master\"
            }"